<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogo Hard Disk</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #eef2f7; padding: 20px; }
        .container { width: 90%; max-width: 1200px; margin: auto; padding: 30px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; }
        #summary-section { background-color: #f7f9fc; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .summary-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #search-container { margin-bottom: 30px; display: flex; gap: 10px; }
        #searchInput { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        #searchButton { background-color: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; }
        #clearButton { background-color: #95a5a6; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; }
        .search-result-item { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #3498db; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .highlight { background-color: #fff59d; font-weight: bold; border-radius: 2px; }
        .hdd-label { color: #e74c3c; font-weight: bold; }
        .hdd-section { margin-bottom: 15px; border-radius: 10px; background-color: #fafbfd; border: 1px solid #eee; }
        .hdd-title { padding: 15px; cursor: pointer; background: #f7f9fc; margin: 0; display: flex; justify-content: space-between; }
        ul { list-style: none; padding-left: 20px; }
        .folder { font-weight: bold; cursor: pointer; color: #2c3e50; }
        .file { color: #555; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Catalogo Hard Disk</h1>
        <div id="summary-section">
            <h2>Riepilogo Database</h2>
            <div class="summary-grid" id="summary-content">
                <div class="summary-card"><p id="total-video-files">Caricamento...</p></div>
                <div class="summary-card"><p id="total-space">...</p></div>
            </div>
        </div>

        <div id="search-container">
            <input type="text" id="searchInput" placeholder="Cerca sequenza esatta (es: 'la casa')...">
            <button id="searchButton">Cerca</button>
            <button id="clearButton">Pulisci</button>
        </div>
        <div id="search-results-count"></div>
        <div id="results-container"></div>
    </div>

    <script>
        const HDD_JSON_MAP = {
            "Arietty": "data/Arietty.json", "SOA": "data/SOA.json", "Hikvision2TB": "data/Hikvision2TB.json",
            "TR3NTON": "data/TR3NTON.json", "Seagate1TB": "data/Seagate1TB.json", "Rufy": "data/Rufy.json",
            "Nami": "data/Nami.json", "Zoro": "data/Zoro.json", "Usopp": "data/usopp.json",
            "Franky": "data/franky.json", "NASWare": "data/NASWare.json", "Seagate0FM": "data/Seagate0FM.json",
            "Seagate878": "data/Seagate878.json", "SeagateGMF": "data/SeagateGMF.json", "SeagateR9H": "data/SeagateR9H.json",
            "WD207": "data/WD207.json", "Maxtor15G": "data/Maxtor15G.json", "WD_Sarah_2TB": "data/WD_Sarah_2TB.json",
        };

        let database = {};

        document.addEventListener("DOMContentLoaded", async () => {
            await loadDatabase();
            updateSummary();
            renderResults();
            
            document.getElementById("searchButton").onclick = () => searchDatabase(document.getElementById("searchInput").value);
            document.getElementById("clearButton").onclick = () => {
                document.getElementById("searchInput").value = "";
                document.getElementById("search-results-count").innerHTML = "";
                renderResults();
            };
            document.getElementById("searchInput").onkeypress = (e) => { if(e.key === 'Enter') searchDatabase(e.target.value); };
        });

        async function loadDatabase() {
            const promises = Object.entries(HDD_JSON_MAP).map(([name, path]) => 
                fetch(path).then(r => r.json()).then(data => database[name] = { files: data.catalogo_video || [], info: data.informazioni_disco })
                .catch(() => database[name] = { files: [], info: null })
            );
            await Promise.allSettled(promises);
        }

        function updateSummary() {
            let total = 0;
            for (let h in database) total += database[h].files.length;
            document.getElementById("total-video-files").innerText = `Totale file: ${total}`;
        }

        // --- LOGICA DI RICERCA CORRETTA ---

        function createSearchRegex(query) {
            // Puliamo i caratteri speciali
            let escaped = query.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            // Trasformiamo lo spazio in un pattern che accetta SPAZIO, PUNTO, UNDERSCORE o TRATTINO
            // Esempio: "la casa" -> "la[\\s\\._\\-]casa"
            let pattern = escaped.replace(/\\\s+/g, '[\\s\\._\\-]');
            
            // Usiamo dei "Lookaround" invece di \b per gestire correttamente i punti
            // Questo dice: trova la sequenza se NON Ã¨ preceduta o seguita da altre lettere/numeri
            return new RegExp(`(?<![a-z0-9])(${pattern})(?![a-z0-9])`, 'gi');
        }

        function highlightText(text, query) {
            if (!query.trim()) return text;
            const regex = createSearchRegex(query);
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function searchDatabase(query) {
            const container = document.getElementById("results-container");
            const countLabel = document.getElementById("search-results-count");
            container.innerHTML = "";
            if (!query.trim()) { renderResults(); return; }

            const results = [];
            const regex = createSearchRegex(query);

            for (const hdd in database) {
                database[hdd].files.forEach(file => {
                    // Testiamo la regex sul nome del file
                    if (regex.test(file.nome) || regex.test(file.percorso_completo)) {
                        results.push({ hdd, ...file });
                    }
                    regex.lastIndex = 0; // Reset della regex per il prossimo test
                });
            }

            countLabel.innerHTML = `Trovati ${results.length} risultati per "${query}"`;
            results.forEach(r => {
                const div = document.createElement("div");
                div.className = "search-result-item";
                div.innerHTML = `
                    <div class="search-result-name">${highlightText(r.nome, query)}</div>
                    <div><span class="hdd-label">HDD: ${r.hdd}</span> â€¢ ${r.dimensione}</div>
                    <div style="font-size:0.8em; color:gray;">${highlightText(r.percorso_completo, query)}</div>
                `;
                container.appendChild(div);
            });
        }

        // --- FUNZIONI DI VISUALIZZAZIONE ALBERO ---

        function buildFileTree(files) {
            const root = { _files: [] };
            files.forEach(file => {
                let parts = file.percorso_completo.split("\\").filter(p => !p.includes(':') && p !== "");
                let current = root;
                parts.forEach((part, i) => {
                    if (i === parts.length - 1) {
                        if (!current._files) current._files = [];
                        current._files.push({ name: part, size: file.dimensione });
                    } else {
                        if (!current[part]) current[part] = { _files: [] };
                        current = current[part];
                    }
                });
            });
            return root;
        }

        function renderTree(node) {
            const ul = document.createElement("ul");
            for (let key in node) {
                if (key === "_files") continue;
                const li = document.createElement("li");
                li.innerHTML = `<span class="folder">ðŸ“‚ ${key}</span>`;
                const childUl = renderTree(node[key]);
                childUl.style.display = "none";
                li.onclick = (e) => { e.stopPropagation(); childUl.style.display = childUl.style.display === "none" ? "block" : "none"; };
                li.appendChild(childUl);
                ul.appendChild(li);
            }
            node._files?.forEach(f => {
                const li = document.createElement("li");
                li.className = "file";
                li.innerHTML = `ðŸ“„ ${f.name} <span style="color:green">(${f.size})</span>`;
                ul.appendChild(li);
            });
            return ul;
        }

        function renderResults() {
            const container = document.getElementById("results-container");
            container.innerHTML = "";
            for (const hdd in database) {
                const section = document.createElement("div");
                section.className = "hdd-section";
                const title = document.createElement("h3");
                title.className = "hdd-title";
                title.innerHTML = `<span>${hdd}</span> <small>${database[hdd].info?.totale || ''}</small>`;
                const tree = renderTree(buildFileTree(database[hdd].files));
                tree.style.display = "none";
                section.onclick = () => tree.style.display = tree.style.display === "none" ? "block" : "none";
                section.append(title, tree);
                container.appendChild(section);
            }
        }
    </script>
</body>
</html>