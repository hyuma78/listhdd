<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catalogo HDD</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #eef2f7;
      color: #2c3e50;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    h1 {
      margin-top: 0;
      text-align: center;
    }

    button, select, input {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #dcdcdc;
      font-size: 15px;
    }

    button {
      background: #3498db;
      color: white;
      cursor: pointer;
      border: none;
    }

    button.secondary {
      background: #7f8c8d;
    }

    button:hover {
      opacity: 0.9;
    }

    #modeSwitch {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 25px;
    }

    #filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    #resultsCount {
      margin-bottom: 15px;
      font-weight: bold;
      color: #3498db;
      text-align: center;
    }

    .result {
      background: #f9fbfd;
      border-left: 4px solid #3498db;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .result small {
      color: #7f8c8d;
      word-break: break-all;
    }

    .hdd {
      margin-bottom: 20px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
    }

    .hdd-header {
      padding: 15px 20px;
      background: #f3f6fa;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
    }

    ul {
      list-style: none;
      margin: 0;
      padding-left: 20px;
    }

    li {
      margin: 3px 0;
    }

    .folder {
      cursor: pointer;
      font-weight: bold;
    }

    .file {
      color: #555;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“€ Catalogo Hard Disk</h1>

    <div id="modeSwitch">
      <button onclick="setMode('catalog')">Catalogo</button>
      <button class="secondary" onclick="setMode('search')">Ricerca</button>
    </div>

    <!-- SEARCH MODE -->
    <div id="searchMode" class="hidden">
      <div id="filters">
        <input id="query" placeholder="Cerca nome o percorsoâ€¦" />
        <select id="hddFilter"><option value="">Tutti i dischi</option></select>
        <select id="extFilter">
          <option value="">Tutte le estensioni</option>
          <option value="mkv">MKV</option>
          <option value="mp4">MP4</option>
          <option value="avi">AVI</option>
          <option value="mov">MOV</option>
        </select>
        <button onclick="search()">Cerca</button>
      </div>
      <div id="resultsCount"></div>
      <div id="results"></div>
    </div>

    <!-- CATALOG MODE -->
    <div id="catalogMode"></div>
  </div>

  <script>
    /* ================= CONFIG ================= */

    const HDD_INFO = {
      Arietty: { size: '2 TB', json: 'data/Arietty.json' },
      SOA: { size: '2 TB', json: 'data/SOA.json' },
      Hikvision2TB: { size: '2 TB', json: 'data/Hikvision2TB.json' },
      TR3NTON: { size: '1 TB', json: 'data/TR3NTON.json' },
      Rufy: { size: '500 GB', json: 'data/Rufy.json' },
      NASWare: { size: '2 TB', json: 'data/NASWare.json' }
    };

    /* ================= STATE ================= */

    let indexedFiles = [];
    let diskInfo = {};
    let mode = 'catalog';

    /* ================= UTILS ================= */

    function normalize(text) {
      return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .trim();
    }

    /* ================= LOAD ================= */

    async function loadAll() {
      for (const [hdd, info] of Object.entries(HDD_INFO)) {
        try {
          const data = await fetch(info.json).then(r => r.json());
          diskInfo[hdd] = data.informazioni_disco || null;

          (data.catalogo_video || []).forEach(f => {
            indexedFiles.push({
              hdd,
              name: f.nome,
              path: f.percorso_completo,
              size: f.dimensione,
              ext: f.nome.split('.').pop().toLowerCase(),
              nameNorm: normalize(f.nome),
              pathNorm: normalize(f.percorso_completo)
            });
          });
        } catch (e) {
          console.warn('Errore caricando', hdd);
        }
      }

      populateHddFilter();
      renderCatalog();
    }

    /* ================= MODE ================= */

    function setMode(m) {
      mode = m;
      document.getElementById('searchMode').classList.toggle('hidden', m !== 'search');
      document.getElementById('catalogMode').classList.toggle('hidden', m !== 'catalog');
    }

    /* ================= SEARCH ================= */

    function populateHddFilter() {
      const sel = document.getElementById('hddFilter');
      Object.keys(HDD_INFO).forEach(hdd => {
        const o = document.createElement('option');
        o.value = hdd;
        o.textContent = hdd;
        sel.appendChild(o);
      });
    }

    function search() {
      const q = normalize(document.getElementById('query').value);
      const hdd = document.getElementById('hddFilter').value;
      const ext = document.getElementById('extFilter').value;
      const out = document.getElementById('results');
      const count = document.getElementById('resultsCount');

      out.innerHTML = '';

      const results = indexedFiles.filter(f => {
        if (q && !f.nameNorm.includes(q) && !f.pathNorm.includes(q)) return false;
        if (hdd && f.hdd !== hdd) return false;
        if (ext && f.ext !== ext) return false;
        return true;
      });

      count.textContent = `Trovati ${results.length} risultati`;

      results.forEach(f => {
        const div = document.createElement('div');
        div.className = 'result';
        div.innerHTML = `<strong>${f.name}</strong><br>
          HDD: ${f.hdd} â€¢ ${f.size}<br>
          <small>${f.path}</small>`;
        out.appendChild(div);
      });
    }

    /* ================= CATALOG ================= */

    function buildTree(files) {
      const root = {};
      files.forEach(f => {
        const parts = f.path.split('\\').filter(Boolean);
        let cur = root;
        parts.forEach((p, i) => {
          if (i === parts.length - 1) {
            cur._files = cur._files || [];
            cur._files.push({ name: p, size: f.size });
          } else {
            cur[p] = cur[p] || {};
            cur = cur[p];
          }
        });
      });
      return root;
    }

    function renderNode(node) {
      const ul = document.createElement('ul');

      for (const key in node) {
        if (key === '_files') continue;
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = 'ðŸ“‚ ' + key;
        span.className = 'folder';
        const child = renderNode(node[key]);
        child.classList.add('hidden');
        span.onclick = () => child.classList.toggle('hidden');
        li.append(span, child);
        ul.appendChild(li);
      }

      (node._files || []).forEach(f => {
        const li = document.createElement('li');
        li.className = 'file';
        li.textContent = `ðŸ“„ ${f.name} (${f.size})`;
        ul.appendChild(li);
      });

      return ul;
    }

    function renderCatalog() {
      const container = document.getElementById('catalogMode');
      container.innerHTML = '';

      for (const hdd of Object.keys(HDD_INFO)) {
        const files = indexedFiles.filter(f => f.hdd === hdd);
        if (!files.length) continue;

        const section = document.createElement('div');
        section.className = 'hdd';

        const header = document.createElement('div');
        header.className = 'hdd-header';
        header.innerHTML = `<span>${hdd}</span><span>${HDD_INFO[hdd].size}</span>`;

        const tree = renderNode(buildTree(files));
        tree.classList.add('hidden');

        header.onclick = () => tree.classList.toggle('hidden');

        section.append(header, tree);
        container.appendChild(section);
      }
    }

    loadAll();
  </script>
</body>
</html>